{{- /*
Datastore Query Template - Extracts datastore data from the fixed schema.

The schema always has vdatastore, vhost, and vhba tables. LEFT JOIN handles
cases where vhba is empty.

For vcenter-level queries (no ClusterFilter), return ALL datastores.
For cluster-level queries, filter to datastores used by hosts in that cluster.

Template Parameters:
  - ClusterFilter: filter by cluster name
  - Limit: max results (0 = unlimited)
  - Offset: skip first N results
*/ -}}
{{- if .ClusterFilter }}
-- Cluster-level: filter to datastores used by hosts in the cluster
WITH expanded AS (
    SELECT
        d.*,
        trim(unnest(string_split(d.Hosts, ','))) AS ip,
        regexp_extract(d."Address", 'vmhba[0-9]+') as hba_device
    FROM vdatastore d
    WHERE d."Hosts" IS NOT NULL
),
with_host AS (
    SELECT DISTINCT
        vh."Cluster",
        e."Address",
        e."Name",
        e."Free MiB",
        e."MHA",
        e."Capacity MiB",
        e."Type",
        e.ip,
        vh."Object ID",
        e.hba_device
    FROM expanded e
    JOIN vhost vh ON vh.Host = e.ip
    WHERE vh."Cluster" = '{{.ClusterFilter}}'
),
with_hba AS (
    SELECT DISTINCT
        w."Cluster",
        w."Address",
        w."Name",
        w."Free MiB",
        w."MHA",
        w."Capacity MiB",
        w."Type",
        w.ip,
        w."Object ID",
        FIRST(hba."Type") OVER (PARTITION BY w."Name") as hba_type
    FROM with_host w
    LEFT JOIN vhba hba ON hba."Device" = w.hba_device
)
SELECT
    w."Cluster" as "cluster",
    COALESCE(w."Address", w."Name") as "diskId",
    ROUND(w."Free MiB"::double / 1024)::integer as "freeCapacityGB",
    COALESCE(w."MHA", false) as "hardwareAcceleratedMove",
    COALESCE(string_agg(DISTINCT w."Object ID", ', '), 'N/A') AS "hostId",
    'N/A' as "model",
    CASE
        WHEN w."Type" = 'NFS' THEN 'N/A'
        WHEN w."Address" LIKE 'naa.%' THEN 'iSCSI'
        WHEN w.hba_type IS NOT NULL THEN w.hba_type
        ELSE 'N/A'
    END as "protocolType",
    ROUND(w."Capacity MiB"::double / 1024)::integer as "totalCapacityGB",
    COALESCE(w."Type", 'N/A') as "type",
    'N/A' as "vendor"
FROM with_hba w
GROUP BY w."Cluster", w."Address", w."Name", w."Free MiB", w."MHA", w."Capacity MiB", w."Type", w.hba_type
{{- if and .Limit (gt .Limit 0) }} LIMIT {{.Limit}}{{end}}
{{- if and .Offset (gt .Offset 0) }} OFFSET {{.Offset}}{{end}};
{{- else }}
-- vCenter-level: return ALL datastores (matching old implementation)
WITH expanded_hosts AS (
    SELECT
        d."Name" as ds_name,
        trim(unnest(string_split(d."Hosts", ','))) AS ip
    FROM vdatastore d
    WHERE d."Hosts" IS NOT NULL AND d."Hosts" != ''
),
host_ids AS (
    SELECT
        e.ds_name,
        string_agg(DISTINCT vh."Object ID", ', ') as host_ids
    FROM expanded_hosts e
    LEFT JOIN vhost vh ON vh."Host" = e.ip
    GROUP BY e.ds_name
)
SELECT
    '' as "cluster",
    COALESCE(d."Name", 'N/A') as "diskId",
    COALESCE(ROUND(d."Free MiB"::double / 1024)::integer, 0) as "freeCapacityGB",
    false as "hardwareAcceleratedMove",
    COALESCE(h.host_ids, 'N/A') AS "hostId",
    'N/A' as "model",
    CASE
        WHEN d."Type" = 'NFS' THEN 'N/A'
        ELSE 'N/A'
    END as "protocolType",
    COALESCE(ROUND(d."Capacity MiB"::double / 1024)::integer, 0) as "totalCapacityGB",
    COALESCE(d."Type", 'N/A') as "type",
    'N/A' as "vendor"
FROM vdatastore d
LEFT JOIN host_ids h ON h.ds_name = d."Name"
{{- if and .Limit (gt .Limit 0) }} LIMIT {{.Limit}}{{end}}
{{- if and .Offset (gt .Offset 0) }} OFFSET {{.Offset}}{{end}};
{{- end }}
