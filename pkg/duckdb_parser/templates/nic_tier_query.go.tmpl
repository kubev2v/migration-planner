{{- /*
NIC Tier Query Template - Returns VM distribution by NIC count tier.
Counts NICs from the vnetwork table to match the old implementation.
Matches the old implementation's nicCountKey function:
  - "0": VMs with 0 NICs
  - "1": VMs with 1 NIC
  - "2": VMs with 2 NICs
  - "3": VMs with 3 NICs
  - "4+": VMs with 4 or more NICs

Template Parameters:
  - ClusterFilter: filter by cluster name
*/ -}}
WITH nic_counts AS (
    SELECT
        i."VM ID" as vm_id,
        COUNT(n."VM ID") as nic_count
    FROM vinfo i
    LEFT JOIN vnetwork n ON i."VM ID" = n."VM ID"
    WHERE 1=1
    {{- if .ClusterFilter }} AND i."Cluster" = '{{.ClusterFilter}}'{{end}}
    GROUP BY i."VM ID"
)
SELECT
    CASE
        WHEN nic_count = 0 THEN '0'
        WHEN nic_count = 1 THEN '1'
        WHEN nic_count = 2 THEN '2'
        WHEN nic_count = 3 THEN '3'
        ELSE '4+'
    END AS tier,
    COUNT(*) AS count
FROM nic_counts
GROUP BY tier;
