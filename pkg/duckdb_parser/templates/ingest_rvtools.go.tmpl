{{- /*
Ingest RVTools Template - Inserts data from Excel sheets into pre-created schema tables.

Strategy:
  - Tables must be created first using create_schema.go.tmpl
  - Uses INSERT INTO ... SELECT to map Excel columns to schema columns
  - Each statement is executed separately to handle missing sheets gracefully
  - all_varchar=true is used for all sheets because Excel has "VM" placeholder in many columns
  - TRY_CAST is used to convert VARCHAR to proper types (INTEGER, BOOLEAN, DOUBLE)
  - TRY_CAST returns NULL if conversion fails (e.g., "VM" placeholder)
*/ -}}
CREATE TABLE vinfo_raw AS
SELECT * FROM read_xlsx('{{.FilePath}}', sheet='vInfo', all_varchar=true);

INSERT INTO vinfo (
    "VM ID", "VM", "Folder ID", "Folder", "Host", "SMBIOS UUID", "VM UUID",
    "Firmware", "Powerstate", "Connection state", "FT State",
    "CPUs", "Memory",
    "OS according to the configuration file", "OS according to the VMware Tools",
    "DNS Name", "Primary IP Address", "In Use MiB",
    "Template", "CBT", "EnableUUID",
    "Datacenter", "Cluster", "HW version",
    "Total disk capacity MiB", "Provisioned MiB", "Resource pool", "VI SDK UUID"
)
SELECT
    "VM ID",
    "VM",
    NULL,
    "Folder",
    "Host",
    COALESCE("VM UUID", NULL),
    "VM UUID",
    "Firmware",
    "Powerstate",
    "Connection state",
    "FT State",
    TRY_CAST("CPUs" AS INTEGER),
    TRY_CAST("Memory" AS INTEGER),
    "OS according to the configuration file",
    "OS according to the VMware Tools",
    "DNS Name",
    "Primary IP Address",
    TRY_CAST("In Use MiB" AS INTEGER),
    CASE WHEN LOWER("Template") IN ('true', '1', 'yes') THEN TRUE WHEN LOWER("Template") IN ('false', '0', 'no') THEN FALSE ELSE NULL END,
    CASE WHEN LOWER("CBT") IN ('true', '1', 'yes') THEN TRUE WHEN LOWER("CBT") IN ('false', '0', 'no') THEN FALSE ELSE NULL END,
    CASE WHEN LOWER("EnableUUID") IN ('true', '1', 'yes') THEN TRUE WHEN LOWER("EnableUUID") IN ('false', '0', 'no') THEN FALSE ELSE NULL END,
    "Datacenter",
    "Cluster",
    "HW version",
    NULL,
    TRY_CAST("Provisioned MiB" AS INTEGER),
    "Resource pool",
    "VI SDK UUID"
FROM vinfo_raw;

WITH cleaned_networks AS (
    SELECT
        "VM ID",
        list(net_val) FILTER (WHERE net_val != 'VM' AND net_val IS NOT NULL) as net_array
    FROM vinfo_raw
    UNPIVOT (
        net_val FOR net_col IN (COLUMNS('Network #.*'))
    )
    GROUP BY "VM ID"
)
UPDATE vinfo
SET
    "Network #1"  = net_array[1],
    "Network #2"  = net_array[2],
    "Network #3"  = net_array[3],
    "Network #4"  = net_array[4],
    "Network #5"  = net_array[5],
    "Network #6"  = net_array[6],
    "Network #7"  = net_array[7],
    "Network #8"  = net_array[8],
    "Network #9"  = net_array[9],
    "Network #10" = net_array[10],
    "Network #11" = net_array[11],
    "Network #12" = net_array[12],
    "Network #13" = net_array[13],
    "Network #14" = net_array[14],
    "Network #15" = net_array[15],
    "Network #16" = net_array[16],
    "Network #17" = net_array[17],
    "Network #18" = net_array[18],
    "Network #19" = net_array[19],
    "Network #20" = net_array[20],
    "Network #21" = net_array[21],
    "Network #22" = net_array[22],
    "Network #23" = net_array[23],
    "Network #24" = net_array[24],
    "Network #25" = net_array[25]
FROM cleaned_networks
WHERE vinfo."VM ID" = cleaned_networks."VM ID";

DROP TABLE vinfo_raw;

INSERT INTO vcpu ("VM ID", "Hot Add", "Hot Remove", "Sockets", "Cores p/s")
SELECT
    "VM ID",
    CASE WHEN LOWER("Hot Add") IN ('true', '1', 'yes') THEN TRUE WHEN LOWER("Hot Add") IN ('false', '0', 'no') THEN FALSE ELSE NULL END,
    CASE WHEN LOWER("Hot Remove") IN ('true', '1', 'yes') THEN TRUE WHEN LOWER("Hot Remove") IN ('false', '0', 'no') THEN FALSE ELSE NULL END,
    TRY_CAST("Sockets" AS INTEGER),
    TRY_CAST("Cores p/s" AS INTEGER)
FROM read_xlsx('{{.FilePath}}', sheet='vCPU', all_varchar=true);

INSERT INTO vmemory ("VM ID", "Hot Add", "Ballooned")
SELECT
    "VM ID",
    CASE WHEN LOWER("Hot Add") IN ('true', '1', 'yes') THEN TRUE WHEN LOWER("Hot Add") IN ('false', '0', 'no') THEN FALSE ELSE NULL END,
    TRY_CAST("Ballooned" AS INTEGER)
FROM read_xlsx('{{.FilePath}}', sheet='vMemory', all_varchar=true);

CREATE TABLE vdisk_raw AS
SELECT * FROM read_xlsx('{{.FilePath}}', sheet='vDisk', all_varchar=true);

-- Add potentially missing columns with NULL defaults
ALTER TABLE vdisk_raw ADD COLUMN IF NOT EXISTS "Sharing mode" VARCHAR;
ALTER TABLE vdisk_raw ADD COLUMN IF NOT EXISTS "Disk UUID" VARCHAR;

INSERT INTO vdisk (
    "VM ID", "Disk Key", "Unit #", "Path", "Disk Path", "Capacity MiB",
    "Sharing mode", "Raw", "Shared Bus", "Disk Mode", "Disk UUID",
    "Thin", "Controller", "Label", "SCSI Unit #"
)
SELECT
    "VM ID",
    "Disk Key",
    "Unit #",
    "Path",
    "Disk Path",
    TRY_CAST("Capacity MiB" AS BIGINT),
    CASE WHEN LOWER("Sharing mode") IN ('true', '1', 'yes') THEN TRUE WHEN LOWER("Sharing mode") IN ('false', '0', 'no') THEN FALSE ELSE NULL END,
    CASE WHEN LOWER("Raw") IN ('true', '1', 'yes') THEN TRUE WHEN LOWER("Raw") IN ('false', '0', 'no') THEN FALSE ELSE NULL END,
    "Shared Bus",
    "Disk Mode",
    "Disk UUID",
    CASE WHEN LOWER("Thin") IN ('true', '1', 'yes') THEN TRUE WHEN LOWER("Thin") IN ('false', '0', 'no') THEN FALSE ELSE NULL END,
    "Controller",
    "Label",
    "SCSI Unit #"
FROM vdisk_raw;

DROP TABLE vdisk_raw;

INSERT INTO vdatastore ("Hosts", "Address", "Name", "Free MiB", "MHA", "Capacity MiB", "Type")
SELECT
    "Hosts",
    "Address",
    "Name",
    TRY_CAST("Free MiB" AS DOUBLE),
    CASE WHEN LOWER("MHA") IN ('true', '1', 'yes') THEN TRUE WHEN LOWER("MHA") IN ('false', '0', 'no') THEN FALSE ELSE NULL END,
    TRY_CAST("Capacity MiB" AS DOUBLE),
    "Type"
FROM read_xlsx('{{.FilePath}}', sheet='vDatastore', all_varchar=true);

INSERT INTO vhost ("Cluster", "# Cores", "# CPU", "Object ID", "# Memory", "Model", "Vendor", "Host", "Config status")
SELECT
    "Cluster",
    TRY_CAST("# Cores" AS INTEGER),
    TRY_CAST("# CPU" AS INTEGER),
    "Object ID",
    TRY_CAST("# Memory" AS INTEGER),
    "Model",
    "Vendor",
    "Host",
    COALESCE(NULLIF("Config status", ''), 'green')
FROM read_xlsx('{{.FilePath}}', sheet='vHost', all_varchar=true);

INSERT INTO vhba ("Device", "Type")
SELECT "Device", "Type"
FROM read_xlsx('{{.FilePath}}', sheet='vHBA', all_varchar=true);

INSERT INTO vnetwork (
    "VM ID", "Network", "Mac Address", "NIC label", "Adapter", "Switch",
    "Connected", "Starts Connected", "Type", "IPv4 Address", "IPv6 Address", "Cluster"
)
SELECT
    "VM ID",
    "Network",
    "Mac Address",
    "NIC label",
    "Adapter",
    "Switch",
    CASE WHEN LOWER("Connected") IN ('true', '1', 'yes') THEN TRUE WHEN LOWER("Connected") IN ('false', '0', 'no') THEN FALSE ELSE NULL END,
    CASE WHEN LOWER("Starts Connected") IN ('true', '1', 'yes') THEN TRUE WHEN LOWER("Starts Connected") IN ('false', '0', 'no') THEN FALSE ELSE NULL END,
    "Type",
    "IPv4 Address",
    "IPv6 Address",
    "Cluster"
FROM read_xlsx('{{.FilePath}}', sheet='vNetwork', all_varchar=true);

INSERT INTO dvport ("Port", "VLAN")
SELECT "Port", "VLAN"
FROM read_xlsx('{{.FilePath}}', sheet='dvPort', all_varchar=true);
