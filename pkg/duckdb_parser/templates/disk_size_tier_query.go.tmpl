{{- /*
Disk Size Tier Query Template - Returns VM distribution by total disk size tier.

This query counts ALL VMs from vinfo, including those with 0 disks.
VMs with no disk entries are counted with 0 TB capacity and fall into "Easy (0-10TB)".
This matches the old implementation behavior.

Template Parameters:
  - ClusterFilter: filter by cluster name
*/ -}}
WITH vm_disk_totals AS (
    SELECT
        i."VM ID",
        COALESCE(SUM(d."Capacity MiB"), 0) / 1048576.0 AS total_disk_tb
    FROM vinfo i
    LEFT JOIN vdisk d ON i."VM ID" = d."VM ID"
    WHERE 1=1
    {{- if .ClusterFilter }} AND i."Cluster" = '{{.ClusterFilter}}'{{end}}
    GROUP BY i."VM ID"
)
SELECT
    CASE
        WHEN total_disk_tb < 10 THEN 'Easy (0-10TB)'
        WHEN total_disk_tb < 20 THEN 'Medium (10-20TB)'
        WHEN total_disk_tb < 50 THEN 'Hard (20-50TB)'
        ELSE 'White Glove (>50TB)'
    END AS tier,
    COUNT(*) AS vm_count,
    ROUND(SUM(total_disk_tb), 2) AS total_size_tb
FROM vm_disk_totals
GROUP BY tier;
