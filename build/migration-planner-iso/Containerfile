FROM --platform=linux/amd64 quay.io/centos/centos:stream9 AS builder

ARG ISO_URL ISO_CHECKSUM AGENT_IMAGE

USER root

# Copy the configuration script into the container
COPY build/migration-planner-iso/build-ove-image.sh /tmp/

RUN chmod +x /tmp/build-ove-image.sh

RUN dnf -y update; micro-dnf -y reinstall shadow-utils; \
dnf -y install podman runc ; \
rm -rf /var/cache /var/log/dnf* /var/log/yum.*

# Use runc as containers engine
RUN mkdir -p /etc/containers/ && \
  echo "[engine]" >> /etc/containers/containers.conf && \
  echo "runtime=\"runc\"" >> /etc/containers/containers.conf

# Do the postprocessing step to generate the OVE ISO
RUN dnf install -y xorriso skopeo rsync syslinux \
 && dnf clean all

# Download the ISO
RUN curl -L --fail --show-error --progress-bar -o /initial-rhcos.iso ${ISO_URL}

# Verify checksum
RUN echo "${ISO_CHECKSUM}  /initial-rhcos.iso" | sha256sum -c -

# Create output directory
RUN mkdir -p /output

# Run the build script with the downloaded ISO file and config values
RUN /tmp/build-ove-image.sh \
    --iso-file /initial-rhcos.iso \
    --dir / \
    --output-file /output/final.iso \
    --agent-image ${AGENT_IMAGE} \
    && rm /initial-rhcos.iso && rm -rf /isomnt

# Final stage with minimal image
FROM --platform=linux/amd64 registry.access.redhat.com/ubi9/ubi-minimal AS final

ARG FINAL_ISO_PATH

COPY --from=builder /output/final.iso ${FINAL_ISO_PATH}

ENTRYPOINT ["/bin/bash"]